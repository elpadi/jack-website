define(["../math/NumberRange","../math/geometry/Point","../math/geometry/Dims2d","../math/math","../dom","../functions"],function(NumberRange,Point,Dims2d,math,dom,fn){function Kaleidoscope(){this.clipX=new NumberRange(0,1);this.clipY=new NumberRange(0,1);this.clipPoint=new Point;this.slicePoints={};this.sliceDimensions=new Dims2d(0,0);this.clipDimensions=new Dims2d(0,0);this.options={imageSource:"",isMouseAnimationEnabled:false,sliceCount:4,imageClipPointIncrement:1};this.finalCanvas=document.createElement("canvas");this.bufferCanvas=document.createElement("canvas");this.canvases=[];this.image=new Image;this.imageFlipped=new Image;this.oImage=new Image;this.framesTimes=[]}Kaleidoscope.prototype={isRunning:false,animationIntervalId:0,skipAnimationTick:false,resetPiecesBeforeDrawing:true,DROP_RESET_FRAME_RATE:18,INITIAL_FRAME_RATE_CHECK_DURATION:2e3,FRAME_RATE_FRAME_COUNT:100,setOption:function(name,value){if(name in this.options){this.options[name]=value}},flipImage:function(){var canvas=document.createElement("canvas");var context=canvas.getContext("2d");canvas.width=this.image.width;canvas.height=this.image.height;context.transform(-1,0,0,1,0,0);context.drawImage(this.image,canvas.width*-1,0);this.imageFlipped.src=canvas.toDataURL()},changeImage:function(src){this.image=new Image;this.oImage.src=src},setImageEdges:function(){var c=document.createElement("canvas"),ctx=c.getContext("2d"),_this=this,i=this.image,p;c.width=this.oImage.width+this.clipDimensions.width;c.height=this.oImage.height+this.clipDimensions.height;p=ctx.createPattern(this.oImage,"repeat");ctx.rect(0,0,c.width,c.height);ctx.fillStyle=p;ctx.fill();$(i).one("load",function(){_this.image=i;_this.flipImage();_this.setClippingRange()});i.src=c.toDataURL()},updateSlices:function(){this.updateSliceDimensions();if(this.image.width===0){this.setImageEdges()}this.generateCanvases()},getSliceWidth:function(){var r=this.sliceDimensions.height,n=this.options.sliceCount;return Math.ceil(2*r*Math.tan(Math.PI/n))},updateSliceDimensions:function(){this.finalCanvas.width=this.$container.width();this.finalCanvas.height=this.$container.height();this.bufferCanvas.width=this.finalCanvas.width;this.bufferCanvas.height=this.finalCanvas.height;this.sliceDimensions.setHeight(this.bufferCanvas.height/2);this.sliceDimensions.setWidth(this.getSliceWidth());this.updateSlicePoints();this.clipDimensions.contain(Dims2d.fromObject(this.oImage),this.sliceDimensions.aspectRatio);this.options.imageClipPointIncrement=Math.ceil(math.percent(this.clipDimensions.width,1))},setClippingRange:function(){this.clipX.setEdgeValues(0,this.image.width-this.clipDimensions.width);this.clipY.setEdgeValues(0,this.image.height-this.clipDimensions.height);this.clipX.setValue(Math.round((this.image.width-this.clipDimensions.width)/2));this.clipY.setValue(Math.round((this.image.height-this.clipDimensions.height)/2))},updateSlicePoints:function(){this.slicePoints={topMiddle:new Point(0,0),bottomLeft:new Point(this.sliceDimensions.width/-2,this.sliceDimensions.height),bottomRight:new Point(this.sliceDimensions.width/2,this.sliceDimensions.height)}},generateCanvases:function(){this.canvases=_.map(_.range(this.options.sliceCount),_.bind(this.generateCanvas,this))},generateCanvas:function(positionIndex){var c=document.createElement("canvas");c.className="kscope-canvas";if(!this.resetPiecesBeforeDrawing){this.resetCanvas(c,positionIndex)}return c},getFrameRate:function(){var l=this.framesTimes.length;var start=this.framesTimes[0];var end=this.framesTimes[l-1];return l/((end-start)/1e3)},resetCanvas:function(canvas,positionIndex){var ctx=canvas.getContext("2d");canvas.width=this.bufferCanvas.width;canvas.height=this.bufferCanvas.height;ctx.translate(this.bufferCanvas.width/2,this.bufferCanvas.height/2);ctx.rotate(positionIndex*Math.PI*2/this.options.sliceCount);this.clipCanvasToSlice(ctx)},clipCanvasToSlice:function(ctx){ctx.beginPath();ctx.moveTo(this.slicePoints.topMiddle.x,this.slicePoints.topMiddle.y);ctx.lineTo(this.slicePoints.bottomLeft.x,this.slicePoints.bottomLeft.y);ctx.lineTo(this.slicePoints.bottomRight.x,this.slicePoints.bottomRight.y);ctx.lineTo(this.slicePoints.topMiddle.x,this.slicePoints.topMiddle.y);ctx.closePath();ctx.clip()},drawNormalCanvas:function(canvas){var sx=this.clipPoint.x,sy=this.clipPoint.y,sw=this.clipDimensions.width,sh=this.clipDimensions.height,dx=this.sliceDimensions.width/-2,dy=0,dw=this.sliceDimensions.width,dh=this.sliceDimensions.height;canvas.getContext("2d").clearRect(dx-1,dy-1,dw+2,dh+2);canvas.getContext("2d").drawImage(this.image,sx,sy,sw,sh,dx,dy,dw,dh)},drawFlippedCanvas:function(canvas){var sx=this.image.width-this.clipPoint.x-this.clipDimensions.width,sy=this.clipPoint.y,sw=this.clipDimensions.width,sh=this.clipDimensions.height,dx=this.sliceDimensions.width/-2,dy=0,dw=this.sliceDimensions.width,dh=this.sliceDimensions.height;canvas.getContext("2d").clearRect(dx-1,dy-1,dw+2,dh+2);canvas.getContext("2d").drawImage(this.imageFlipped,sx,sy,sw,sh,dx,dy,dw,dh)},drawImageToCanvases:function(){var bCtx=this.bufferCanvas.getContext("2d");bCtx.clearRect(-1,-1,this.bufferCanvas.width+2,this.bufferCanvas.height+2);_.each(this.canvases,this.bind(function(canvas,index){if(this.resetPiecesBeforeDrawing){this.resetCanvas(canvas,index)}this["draw"+(index%2===0?"Normal":"Flipped")+"Canvas"](canvas);bCtx.drawImage(canvas,0,0)}));this.finalCanvas.getContext("2d").clearRect(-1,-1,this.bufferCanvas.width+2,this.bufferCanvas.height+2);this.finalCanvas.getContext("2d").drawImage(this.bufferCanvas,0,0)},onAnimationIntervalTick:function(){if(!this.skipAnimationTick){this.clipX.add(this.options.imageClipPointIncrement)}this.skipAnimationTick=false;this.clipPoint.setX(this.clipX.getValue());this.clipPoint.setY(this.clipY.getValue());this.drawImageToCanvases();this.framesTimes.push((new Date).getTime());if(this.framesTimes.length>this.FRAME_RATE_FRAME_COUNT){this.framesTimes.shift()}},stop:function(){clearInterval(this.animationIntervalId);this.isRunning=false},animate:function(){var _this=this;this.isRunning=true;this.framesTimes=[];this.resetPiecesBeforeDrawing=true;setTimeout(function(){var fr=_this.getFrameRate();_this.resetPiecesBeforeDrawing=fr>_this.DROP_RESET_FRAME_RATE},this.INITIAL_FRAME_RATE_CHECK_DURATION);this.animationIntervalId=setInterval(this.bind(this.onAnimationIntervalTick),1e3/24)},togglePause:function(){if(this.isRunning){this.stop()}else{this.animate()}},bind:function(fn){return _.bind(fn,this)}};return Kaleidoscope});